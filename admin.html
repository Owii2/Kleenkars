<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Kleenkars — Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0b0b12;--card:#13131b;--ink:#e9e9ef;--muted:#b8b8c6;--border:#242433;--accent:#7a3cff}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,sans-serif;background:var(--bg);color:var(--ink)}
  /* Header with logo */
  header{
    display:flex;align-items:center;justify-content:space-between;
    padding:12px 20px;background:#111018;border-bottom:1px solid var(--border)
  }
  .logo-title{display:flex;align-items:center;gap:12px;min-height:56px}
  .logo{
    width:100px;height:100px;object-fit:contain;display:block;
    background:#0f0f16;border:1px solid var(--border);border-radius:10px;
  }
  .title{font-weight:800;font-size:1.2rem}

  /* Toolbar directly under header */
  .toolbar{
    background:#111018;border-bottom:1px solid var(--border);
    padding:10px 20px; position:sticky; top:0; z-index:10;
  }
  .actions{display:none;gap:8px;flex-wrap:wrap}
  .btn{background:var(--accent);border:0;color:#fff;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
  .btn.secondary{background:#2a2a3a}
  .btn.danger{background:#d64545}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .wrap{max-width:1120px;margin:auto;padding:20px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px}
  .p24{padding:24px}
  .muted{color:var(--muted)}
  .section{display:none}
  .section.active{display:block}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0f0f16;color:#fff}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
  thead th{background:#1a1a25;position:sticky;top:0}

  /* Responsive rows for filters/forms to prevent overlap */
  .bar .row, #editWrap .row, #services .row{
    display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:12px; align-items:end;
  }
  .bar .row label, #editWrap .row label, #services .row label{
    display:flex; flex-direction:column; min-width:0;
  }

  .bar{display:flex;gap:12px;align-items:end;flex-wrap:wrap}
  .pill{display:inline-block;padding:4px 8px;border:1px solid var(--border);border-radius:999px;color:var(--muted);font-size:.8rem}
  canvas{width:100%;max-width:100%;height:320px;border:1px solid var(--border);border-radius:10px;background:#0f0f16}
</style>
</head>
<body>
  <!-- HEADER: only logo + title -->
  <header>
    <div class="logo-title">
      <img src="/assets/logo.png" alt="Kleenkars logo" class="logo" onerror="this.src='/logo.svg'">
      <span class="title">Admin</span>
    </div>
  </header>

  <!-- TOOLBAR: buttons live here (shown after login by JS) -->
  <nav class="toolbar">
    <div id="actions" class="actions">
      <button data-tab="bookings" class="btn secondary">Bookings</button>
      <button data-tab="stats" class="btn secondary">Statistics</button>
      <button data-tab="services" class="btn secondary">Services</button>
      <button id="logout" class="btn">Logout</button>
    </div>
  </nav>

  <!-- LOGIN (visible first) -->
  <div id="loginPanel" class="wrap">
    <div class="card p24" style="max-width:420px;margin:60px auto;">
      <h2 style="margin:0 0 8px;">Admin Login</h2>
      <p class="muted" style="margin:0 0 16px;">Enter your credentials.</p>
      <input id="user" type="text" placeholder="Username" autocomplete="username" />
      <input id="pass" type="password" placeholder="Password" autocomplete="current-password" />
      <button id="loginBtn" class="btn" style="width:100%;margin-top:6px;">Login</button>
      <div id="loginMsg" class="muted" style="margin-top:10px;"></div>
    </div>
  </div>

  <!-- APP (hidden until login) -->
  <div id="app" class="wrap" style="display:none;">

    <!-- Bookings -->
    <section id="bookings" class="section active">
      <div class="card p24">
        <div class="bar">
          <div><b>Filters</b></div>
          <div class="row">
            <label>Date from<input type="date" id="fFrom"></label>
            <label>Date to<input type="date" id="fTo"></label>
            <label>Service
              <select id="fService">
                <option value="">All</option>
                <option>Basic</option><option>Premium</option><option>Detailing</option>
              </select>
            </label>
            <label>Name/Phone<input id="fSearch" placeholder="Type to filter"></label>
          </div>
          <button id="fApply" class="btn">Apply</button>
          <button id="fClear" class="btn secondary">Clear</button>
          <span class="pill" id="count">—</span>
        </div>

        <div style="overflow:auto;margin-top:10px;">
          <table>
            <thead>
              <tr>
                <th>#</th><th>Name</th><th>Phone</th><th>Vehicle</th><th>Service</th>
                <th>Date</th><th>Time</th><th>Visit</th><th>Price</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="rows"><tr><td colspan="10" class="muted">Loading…</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- Editor -->
      <div id="editWrap" class="card p24" style="margin-top:12px;display:none;">
        <h3 id="editTitle" style="margin:0 0 10px;">Edit booking</h3>
        <div class="row" style="gap:12px;">
          <label>Customer name<input id="eName"></label>
          <label>Phone<input id="ePhone" inputmode="numeric" maxlength="15"></label>
          <label>Date<input type="date" id="eDate"></label>
          <label>Time<input type="time" id="eTime" step="900"></label>
          <label>Vehicle
            <select id="eVehicle"><option>Bike</option><option>Hatch/Sedan</option><option>SUV</option></select>
          </label>
          <label>Service
            <select id="eService"><option>Basic</option><option>Premium</option><option>Detailing</option></select>
          </label>
          <label>Visit
            <select id="eVisit"><option>Wash Center</option><option>Home Visit</option></select>
          </label>
          <label style="grid-column:1/-1;">Address<textarea id="eAddress" rows="2"></textarea></label>
        </div>
        <div class="bar" style="margin-top:10px;">
          <span class="pill" id="ePrice">Price: —</span>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button id="save" class="btn">Save</button>
            <button id="delete" class="btn danger">Delete</button>
            <button id="close" class="btn secondary">Close</button>
          </div>
        </div>
        <div id="eMsg" class="muted" style="margin-top:8px;"></div>
      </div>
    </section>

    <!-- Statistics -->
    <section id="stats" class="section">
  <div class="card p24">
    <div class="bar">
      <div><b>Sales Dashboard</b></div>

      <div class="row" style="align-items:flex-end">
        <!-- Group -->
        <label>Group by<br>
          <select id="sGroup">
            <option value="day">Day</option>
            <option value="month" selected>Month</option>
            <option value="year">Year</option>
          </select>
        </label>

        <!-- Day filters -->
        <span id="fltDay" class="row">
          <label>From (date)<br><input type="date" id="sFromDay"></label>
          <label>To (date)<br><input type="date" id="sToDay"></label>
        </span>

        <!-- Month filters -->
        <span id="fltMonth" class="row" style="display:none">
          <label>From (month)<br><input type="month" id="sFromMonth"></label>
          <label>To (month)<br><input type="month" id="sToMonth"></label>
        </span>

        <!-- Year filters -->
        <span id="fltYear" class="row" style="display:none">
          <label>From (year)<br><input type="number" id="sFromYear" min="2000" max="2100" step="1" placeholder="YYYY"></label>
          <label>To (year)<br><input type="number" id="sToYear" min="2000" max="2100" step="1" placeholder="YYYY"></label>
        </span>

        <button id="sApply" class="btn">Apply</button>
        <button id="sCurrentYear" class="btn secondary">Current Year</button>
      </div>

      <!-- KPI pills -->
      <div class="row" style="gap:10px;margin-top:10px;flex-wrap:wrap">
        <span class="pill" id="kpiTotal">Total: —</span>
        <span class="pill" id="kpiBookings">Bookings: —</span>
        <span class="pill" id="kpiAvg">Avg Ticket: —</span>
      </div>
    </div>

    <!-- Charts -->
    <div style="display:grid;grid-template-columns:1fr;gap:16px;margin-top:12px">
      <div class="card p24">
        <div class="muted">Revenue Trend</div>
        <canvas id="chTrend" style="width:100%;height:320px;border:1px solid var(--border);border-radius:10px;background:#0f0f16"></canvas>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div class="card p24">
          <div class="muted">By Service</div>
          <canvas id="chService" style="width:100%;height:280px;border:1px solid var(--border);border-radius:10px;background:#0f0f16"></canvas>
        </div>
        <div class="card p24">
          <div class="muted">By Vehicle</div>
          <canvas id="chVehicle" style="width:100%;height:280px;border:1px solid var(--border);border-radius:10px;background:#0f0f16"></canvas>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div class="card p24">
          <div class="muted">Peak Hours</div>
          <canvas id="chHour" style="width:100%;height:240px;border:1px solid var(--border);border-radius:10px;background:#0f0f16"></canvas>
        </div>
        <div class="card p24">
          <div class="muted">Days of Week</div>
          <canvas id="chDow" style="width:100%;height:240px;border:1px solid var(--border);border-radius:10px;background:#0f0f16"></canvas>
        </div>
      </div>
    </div>

    <div id="sMsg" class="muted" style="margin-top:10px;"></div>
  </div>
</section>

    <!-- Services -->
    <section id="services" class="section">
      <div class="card p24">
        <div class="bar">
          <div><b>Services</b></div>
          <button id="svcRefresh" class="btn secondary">Refresh</button>
        </div>
        <div style="overflow:auto;margin-top:10px;">
          <table>
            <thead>
             <tr>
              <th style="width:56px;">#</th>
              <th>Service</th>
              <th>Bike</th>
              <th>Hatch/Sedan</th>
              <th>SUV</th>
              <th style="width:160px;">Order</th>
              <th>Actions</th>
             </tr>
            </thead>
            <tbody id="svcRows"><tr><td colspan="5" class="muted">Loading…</td></tr></tbody>
          </table>
        </div>

        <h3 style="margin:16px 0 8px;">Add / Update service</h3>
        <div class="row" style="gap:12px;">
          <label>Name<input id="svName" placeholder="e.g., Premium"></label>
          <label>Bike (₹ or blank)<input id="svBike" inputmode="numeric"></label>
          <label>Hatch/Sedan (₹ or blank)<input id="svSedan" inputmode="numeric"></label>
          <label>SUV (₹ or blank)<input id="svSuv" inputmode="numeric"></label>
        </div>
        <div class="bar" style="margin-top:10px;">
          <button id="svSave" class="btn">Save service</button>
          <div id="svMsg" class="muted"></div>
        </div>
      </div>
    </section>

  </div>

<script>
/* ===================== Auth & View Control ===================== */
const TOKEN_KEY = "kleenkars_token";
const els = {
  actions: document.getElementById('actions'),
  loginPanel: document.getElementById('loginPanel'),
  app: document.getElementById('app'),
  loginBtn: document.getElementById('loginBtn'),
  logout: document.getElementById('logout'),
  user: document.getElementById('user'),
  pass: document.getElementById('pass'),
  loginMsg: document.getElementById('loginMsg'),
  navBtns: () => document.querySelectorAll('#actions [data-tab]'),
  sections: () => document.querySelectorAll('.section'),
};

function token(){ return localStorage.getItem(TOKEN_KEY) || ""; }
function setToken(t){ localStorage.setItem(TOKEN_KEY, t); }
function clearToken(){ localStorage.removeItem(TOKEN_KEY); }

function showLogin(){
  els.actions.style.display = "none";
  els.loginPanel.style.display = "block";
  els.app.style.display = "none";
}
function showApp(){
  els.actions.style.display = "flex";
  els.loginPanel.style.display = "none";
  els.app.style.display = "block";
}

async function login(){
  els.loginMsg.textContent="";
  els.loginBtn.disabled=true; els.loginBtn.textContent="Signing in…";
  try{
    const r = await fetch("/.netlify/functions/admin-login", {
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ user: els.user.value.trim(), pass: els.pass.value })
    });
    const d = await r.json();
    if(!r.ok || !d.ok || !d.token) throw new Error(d.error||"Login failed");
    setToken(d.token);
    showApp();
    tabTo('bookings');
    loadBookings();
  }catch(e){ els.loginMsg.textContent = e.message; }
  finally{ els.loginBtn.disabled=false; els.loginBtn.textContent="Login"; }
}
els.loginBtn.addEventListener('click', login);
els.logout.addEventListener('click', ()=>{ clearToken(); showLogin(); });

/* ===================== Tabs ===================== */
function tabTo(id){
  els.sections().forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  els.navBtns().forEach(b=>{
    b.classList.remove('secondary'); b.classList.add('secondary'); // reset
    if(b.dataset.tab===id){ b.classList.remove('secondary'); b.classList.add('btn'); }
  });
  if(id==='bookings') loadBookings();
  if(id==='stats') loadStats();
  if(id==='services') loadServices();
}
document.querySelector('.toolbar').addEventListener('click', (e)=>{
  const btn = e.target.closest('[data-tab]'); if(!btn) return;
  tabTo(btn.dataset.tab);
});

/* ===================== Bookings ===================== */
const b = {
  rows: document.getElementById('rows'), count: document.getElementById('count'),
  fFrom: document.getElementById('fFrom'), fTo: document.getElementById('fTo'), fService: document.getElementById('fService'), fSearch: document.getElementById('fSearch'),
  fApply: document.getElementById('fApply'), fClear: document.getElementById('fClear'),
  editWrap: document.getElementById('editWrap'), editTitle: document.getElementById('editTitle'),
  eName: document.getElementById('eName'), ePhone: document.getElementById('ePhone'), eDate: document.getElementById('eDate'), eTime: document.getElementById('eTime'),
  eVehicle: document.getElementById('eVehicle'), eService: document.getElementById('eService'), eVisit: document.getElementById('eVisit'), eAddress: document.getElementById('eAddress'),
  ePrice: document.getElementById('ePrice'), save: document.getElementById('save'), del: document.getElementById('delete'), close: document.getElementById('close'), eMsg: document.getElementById('eMsg')
};
function esc(s){ return String(s==null?"":s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;"); }
function qs(o){ return Object.entries(o).filter(([,v])=>v!=null && v!=="").map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join("&"); }

async function loadBookings(){
  if(!token()){ showLogin(); return; }
  b.rows.innerHTML = `<tr><td colspan="10" class="muted">Loading…</td></tr>`;
  const url = "/.netlify/functions/admin-bookings?" + qs({
    from:b.fFrom.value, to:b.fTo.value, service:b.fService.value, search:b.fSearch.value.trim()
  });
  try{
    const r = await fetch(url, { headers:{ Authorization:`Bearer ${token()}` }});
    const d = await r.json();
    if(!r.ok || !d.ok) throw new Error(d.error||"Failed to load bookings");
    const rows = d.rows || [];
    b.count.textContent = `${rows.length} bookings`;
    if(rows.length===0){ b.rows.innerHTML = `<tr><td colspan="10" class="muted">No bookings.</td></tr>`; return; }
    b.rows.innerHTML = "";
    rows.forEach(row=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.order_id ?? "-"}</td>
        <td>${esc(row.name)}</td>
        <td>${esc(row.phone)}</td>
        <td>${esc(row.vehicle)}</td>
        <td>${esc(row.service)}</td>
        <td>${esc(row.date)}</td>
        <td>${esc(row.time)}</td>
        <td>${esc(row.visit)}</td>
        <td>${row.price ? "₹"+Number(row.price) : "-"}</td>
        <td>
          <button class="btn secondary" data-act="edit">Edit</button>
          <button class="btn danger" data-act="delete">Delete</button>
        </td>`;
      tr.dataset.booking = JSON.stringify(row);
      b.rows.appendChild(tr);
    });
  }catch(e){
    alert(e.message);
    if(/unauthorized|token/i.test(e.message)){ clearToken(); showLogin(); }
  }
}
b.fApply.addEventListener('click', loadBookings);
b.fClear.addEventListener('click', ()=>{ b.fFrom.value=""; b.fTo.value=""; b.fService.value=""; b.fSearch.value=""; loadBookings(); });

b.rows.addEventListener('click', (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const tr = e.target.closest('tr'); const row = JSON.parse(tr.dataset.booking||"{}");
  if(btn.dataset.act==="edit") openEditor(row);
  if(btn.dataset.act==="delete") adminDelete(row);
});

function openEditor(row){
  b.editTitle.textContent = `Edit #${row.order_id}`;
  b.eName.value = row.name||"";
  b.ePhone.value = row.phone||"";
  b.eDate.value = row.date||"";
  b.eTime.value = row.time||"";
  b.eVehicle.value = row.vehicle||"Hatch/Sedan";
  b.eService.value = row.service||"Basic";
  b.eVisit.value = row.visit||"In-Shop";
  b.eAddress.value = row.address||"";
  b.eMsg.textContent = "";
  updatePriceUI();
  b.editWrap.style.display = "block";
  b.save.onclick = ()=> adminSave(row.order_id);
  b.del.onclick = ()=> adminDelete(row);
}
b.close.addEventListener('click', ()=> b.editWrap.style.display="none");
b.eVehicle.addEventListener('change', ()=>{ if(b.eVehicle.value==="Bike") b.eService.value="Basic"; updatePriceUI(); });
b.eService.addEventListener('change', updatePriceUI);
b.eVisit.addEventListener('change', updatePriceUI);
function updatePriceUI(){
  const P = { "Bike":{Basic:50,Premium:null,Detailing:null}, "Hatch/Sedan":{Basic:150,Premium:200,Detailing:1500}, "SUV":{Basic:200,Premium:250,Detailing:2500} };
  let p = P?.[b.eVehicle.value]?.[b.eService.value] ?? null; if(p==null){ b.ePrice.textContent="Price: —"; return; }
  if(b.eVisit.value==="Home Visit") p += 50; b.ePrice.textContent = `Price: ₹${p}`;
}
async function adminSave(order_id){
  const payload = {
    order_id,
    name: b.eName.value.trim(),
    phone: b.ePhone.value.replace(/\D/g,'').slice(0,15),
    date: b.eDate.value,
    time: b.eTime.value,
    vehicle: b.eVehicle.value,
    service: b.eService.value,
    visit: b.eVisit.value,
    address: b.eAddress.value.trim()
  };
  try{
    const r = await fetch("/.netlify/functions/admin-updateBooking",{
      method:"POST", headers:{ "Content-Type":"application/json", Authorization:`Bearer ${token()}` },
      body: JSON.stringify(payload)
    });
    const d = await r.json();
    if(!r.ok || !d.ok) throw new Error(d.error||"Update failed");
    b.eMsg.textContent = "Saved."; loadBookings();
  }catch(e){ b.eMsg.textContent = e.message; }
}
async function adminDelete(row){
  if(!confirm(`Delete booking #${row.order_id}?`)) return;
  try{
    const r = await fetch("/.netlify/functions/admin-deleteBooking",{
      method:"POST", headers:{ "Content-Type":"application/json", Authorization:`Bearer ${token()}` },
      body: JSON.stringify({ order_id: row.order_id })
    });
    const d = await r.json();
    if(!r.ok || !d.ok) throw new Error(d.error||"Delete failed");
    b.editWrap.style.display="none"; loadBookings();
  }catch(e){ alert(e.message); }
}

// ===================== Statistics =====================
const s = {
  group: document.getElementById('sGroup'),
  fromDay: document.getElementById('sFromDay'),
  toDay: document.getElementById('sToDay'),
  fromMonth: document.getElementById('sFromMonth'),
  toMonth: document.getElementById('sToMonth'),
  fromYear: document.getElementById('sFromYear'),
  toYear: document.getElementById('sToYear'),
  fltDay: document.getElementById('fltDay'),
  fltMonth: document.getElementById('fltMonth'),
  fltYear: document.getElementById('fltYear'),

  apply: document.getElementById('sApply'),
  currentYear: document.getElementById('sCurrentYear'),

  kTotal: document.getElementById('kpiTotal'),
  kBookings: document.getElementById('kpiBookings'),
  kAvg: document.getElementById('kpiAvg'),

  chTrend: document.getElementById('chTrend'),
  chService: document.getElementById('chService'),
  chVehicle: document.getElementById('chVehicle'),
  chHour: document.getElementById('chHour'),
  chDow: document.getElementById('chDow'),

  msg: document.getElementById('sMsg')
};

function setGroupUI() {
  const g = s.group.value;
  s.fltDay.style.display   = g === 'day'   ? 'flex' : 'none';
  s.fltMonth.style.display = g === 'month' ? 'flex' : 'none';
  s.fltYear.style.display  = g === 'year'  ? 'flex' : 'none';
}
s.group.addEventListener('change', setGroupUI);

function qs(o){
  return Object.entries(o)
    .filter(([,v]) => v != null && v !== "")
    .map(([k,v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`)
    .join("&");
}

async function loadStats(){
  s.msg.textContent = "";
  const g = s.group.value;
  let from = "", to = "";

  if (g === 'day')   { from = s.fromDay.value;   to = s.toDay.value; }
  if (g === 'month') { from = s.fromMonth.value; to = s.toMonth.value; }
  if (g === 'year')  { from = s.fromYear.value;  to = s.toYear.value; }

  const url = "/.netlify/functions/admin-stats?" + qs({ group:g, from, to });

  try{
    const r = await fetch(url, { headers:{ Authorization:`Bearer ${token()}` }});
    const d = await r.json();
    if(!r.ok || !d.ok) throw new Error(d.error || "Failed to load stats");
    renderKPIs(d.totals);
    drawTrend(d.points || []);
    drawBars(s.chService, (d.byService||[]).map(x=>({label:x.label||'—', value:+x.total||0})), "₹");
    drawBars(s.chVehicle, (d.byVehicle||[]).map(x=>({label:x.label||'—', value:+x.total||0})), "₹");
    drawBars(s.chHour,    fillSeries(24, d.byHour||[], 'hour'), "");
    drawBars(s.chDow,     mapDowSeries(d.byDow||[]), "");
  }catch(e){
    s.msg.textContent = e.message;
    renderKPIs({ total:0, count:0, avg_ticket:0 });
    drawTrend([]);
    drawBars(s.chService, [], "₹");
    drawBars(s.chVehicle, [], "₹");
    drawBars(s.chHour, [], "");
    drawBars(s.chDow, [], "");
  }
}

function renderKPIs(t){
  s.kTotal.textContent    = `Total: ₹${Number(t.total||0)}`;
  s.kBookings.textContent = `Bookings: ${Number(t.count||0)}`;
  s.kAvg.textContent      = `Avg Ticket: ₹${Number(t.avg_ticket||0)}`;
}

// ---------- Charts (vanilla canvas) ----------
function drawTrend(points){
  const cv = s.chTrend, ctx = cv.getContext('2d');
  const W = cv.width = cv.clientWidth, H = cv.height = 320;
  ctx.clearRect(0,0,W,H);

  if(points.length===0){
    ctx.font = "14px Inter"; ctx.fillText("No data for selected range.", 12, 24); return;
  }

  const padL=40,padR=10,padT=20,padB=40;
  const innerW = W-padL-padR, innerH = H-padT-padB;
  const maxY = Math.max(1, ...points.map(p=>+p.total||0));

  // axes
  ctx.strokeStyle="rgba(255,255,255,.2)";
  ctx.beginPath(); ctx.moveTo(padL,padT); ctx.lineTo(padL,H-padB); ctx.lineTo(W-padR,H-padB); ctx.stroke();

  // polyline
  ctx.beginPath();
  points.forEach((p,i)=>{
    const x = padL + (innerW*(i/(points.length-1||1)));
    const y = H - padB - (innerH*((+p.total||0)/maxY));
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();

  // points + labels
  ctx.font="12px Inter"; ctx.textAlign="center"; ctx.textBaseline="top";
  points.forEach((p,i)=>{
    const x = padL + (innerW*(i/(points.length-1||1)));
    const y = H - padB - (innerH*((+p.total||0)/maxY));
    ctx.fillRect(x-2,y-2,4,4);
    ctx.fillText(String(p.label), x, H-padB+6);
  });
}

function drawBars(canvas, items, prefix){
  const ctx = canvas.getContext('2d');
  const W = canvas.width = canvas.clientWidth, H = canvas.height = parseInt((canvas.getAttribute('height')||240),10);
  ctx.clearRect(0,0,W,H);

  if(!items.length){ ctx.font="14px Inter"; ctx.fillText("No data.", 12, 24); return; }

  const padL=40,padR=10,padT=20,padB=40;
  const innerW = W-padL-padR, innerH = H-padT-padB;
  const maxV = Math.max(1, ...items.map(i=>i.value||0));
  const barGap = 10, barW = Math.max(8, (innerW/items.length)-barGap);

  // axes
  ctx.strokeStyle="rgba(255,255,255,.2)";
  ctx.beginPath(); ctx.moveTo(padL,padT); ctx.lineTo(padL,H-padB); ctx.lineTo(W-padR,H-padB); ctx.stroke();

  // y ticks
  ctx.font="12px Inter"; ctx.textAlign="right"; ctx.textBaseline="middle";
  const ticks=4;
  for(let i=0;i<=ticks;i++){
    const v = Math.round((maxV*i)/ticks);
    const y = H-padB - (innerH*i/ticks);
    ctx.fillText(String(v), padL-6, y);
    ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke();
  }

  // bars
  ctx.textAlign="center"; ctx.textBaseline="top";
  items.forEach((it, idx)=>{
    const x = padL + idx*(barW+barGap) + barGap/2;
    const val = it.value||0;
    const h = (val/maxV)*innerH;
    const y = H-padB - h;
    ctx.fillRect(x, y, barW, h);
    const lbl = it.label?.toString().slice(0,12) || "—";
    ctx.fillText(lbl, x+barW/2, H-padB+6);
  });
}

function fillSeries(N, rows, key){
  const map = new Map(rows.map(r=>[Number(r[key]), Number(r.total)||0]));
  const out = [];
  for(let i=0;i<N;i++){ out.push({ label: String(i), value: map.get(i)||0 }); }
  return out;
}
function mapDowSeries(rows){
  const NAMES = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  const map = new Map(rows.map(r=>[Number(r.dow), Number(r.total)||0]));
  return NAMES.map((n,i)=>({ label:n, value: map.get(i)||0 }));
}

// Quick: Current Year (sets group=month and range Jan..Dec of current year)
s.currentYear.addEventListener('click', ()=>{
  const now = new Date(); const y = now.getFullYear();
  s.group.value = 'month'; setGroupUI();
  s.fromMonth.value = `${y}-01`; s.toMonth.value = `${y}-12`;
  loadStats();
});

s.apply.addEventListener('click', loadStats);

// Boot defaults: current year by month (ensures a non-blank graph)
(function boot(){
  const now = new Date(); const y = now.getFullYear();
  s.group.value = 'month'; setGroupUI();
  s.fromMonth.value = `${y}-01`; s.toMonth.value = `${y}-12`;
  loadStats();
})();

/* ===================== Services ===================== */
const svc = {
  rows: document.getElementById('svcRows'),
  name: document.getElementById('svName'),
  bike: document.getElementById('svBike'),
  sedan: document.getElementById('svSedan'),
  suv: document.getElementById('svSuv'),
  save: document.getElementById('svSave'),
  msg: document.getElementById('svMsg'),
  refresh: document.getElementById('svcRefresh'),
  originalName: null
};

svc.refresh.addEventListener('click', loadServices);
svc.save.addEventListener('click', saveService);

async function loadServices(){
  if(!token()){ showLogin(); return; }
  svc.rows.innerHTML = `<tr><td colspan="7" class="muted">Loading…</td></tr>`;
  try{
    const r = await fetch("/.netlify/functions/admin-services", { headers:{ Authorization:`Bearer ${token()}` }});
    const d = await r.json();
    if(!r.ok || !d.ok) throw new Error(d.error||"Failed");
    const rows = d.rows || [];
    if(rows.length===0){ svc.rows.innerHTML = `<tr><td colspan="7" class="muted">No services.</td></tr>`; return; }

    svc.rows.innerHTML = "";
    rows.forEach((s, idx)=>{
      const tr = document.createElement('tr');
      const fmt = v=> v==null ? "<span class='muted'>—</span>" : "₹"+Number(v);
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${esc(s.name)}</td>
        <td>${fmt(s.bike)}</td>
        <td>${fmt(s.sedan)}</td>
        <td>${fmt(s.suv)}</td>
        <td>
          <button class="btn secondary" data-act="up">↑</button>
          <button class="btn secondary" data-act="down">↓</button>
        </td>
        <td>
          <button class="btn secondary" data-act="edit">Edit</button>
          <button class="btn danger" data-act="del">Delete</button>
        </td>`;
      tr.dataset.service = JSON.stringify(s);
      svc.rows.appendChild(tr);
    });
  }catch(e){ alert(e.message); }
}

document.getElementById('svcRows').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const tr = e.target.closest('tr'); const s = JSON.parse(tr.dataset.service||"{}");

  if(btn.dataset.act==='edit'){
    svc.originalName = s.name;
    svc.name.value = s.name;
    svc.bike.value = s.bike ?? "";
    svc.sedan.value = s.sedan ?? "";
    svc.suv.value = s.suv ?? "";
    svc.msg.textContent = "Loaded into form. Edit and click Save service.";
  }

  if(btn.dataset.act==='del'){
    if(!confirm(`Delete service "${s.name}"?`)) return;
    try{
      const r = await fetch("/.netlify/functions/admin-services", {
        method:"DELETE",
        headers:{ "Content-Type":"application/json", Authorization:`Bearer ${token()}` },
        body: JSON.stringify({ name: s.name })
      });
      const d = await r.json();
      if(!r.ok || !d.ok) throw new Error(d.error||"Delete failed");
      svc.originalName = null;
      svc.name.value = ""; svc.bike.value = ""; svc.sedan.value = ""; svc.suv.value = "";
      loadServices();
    }catch(err){ alert(err.message); }
  }

  if(btn.dataset.act==='up' || btn.dataset.act==='down'){
    try{
      const r = await fetch("/.netlify/functions/admin-services", {
        method:"PATCH",
        headers:{ "Content-Type":"application/json", Authorization:`Bearer ${token()}` },
        body: JSON.stringify({ name: s.name, direction: btn.dataset.act })
      });
      const d = await r.json();
      if(!r.ok || !d.ok) throw new Error(d.error||"Reorder failed");
      loadServices();
    }catch(err){ alert(err.message); }
  }
});

async function saveService(){
  const payload = {
    originalName: svc.originalName || svc.name.value.trim(), // allow rename if edited
    name: svc.name.value.trim(),
    bike: toIntOrNull(svc.bike.value),
    sedan: toIntOrNull(svc.sedan.value),
    suv: toIntOrNull(svc.suv.value)
  };
  if(!payload.name){ svc.msg.textContent = "Enter service name."; return; }
  try{
    const r = await fetch("/.netlify/functions/admin-services", {
      method:"POST",
      headers:{ "Content-Type":"application/json", Authorization:`Bearer ${token()}` },
      body: JSON.stringify(payload)
    });
    const d = await r.json();
    if(!r.ok || !d.ok) throw new Error(d.error||"Save failed");
    svc.msg.textContent = "Saved.";
    svc.originalName = payload.name; // next save treats it as same row
    loadServices();
  }catch(e){ svc.msg.textContent = e.message; }
}
function toIntOrNull(v){ v=String(v||"").trim(); if(v==="") return null; const n=parseInt(v,10); return Number.isFinite(n)?n:null; }
  
/* ===================== Boot ===================== */
if(token()){ showApp(); tabTo('bookings'); loadBookings(); } else showLogin();
</script>
</body>
</html>
