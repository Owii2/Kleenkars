<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kleenkars — Premium Wash & Detailing</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0b0b12;--card:#13131b;--ink:#e9e9ef;--muted:#b8b8c6;--accent:#7a3cff;--accent-2:#111016;--border:#242433;--radius:16px;--shadow:0 10px 30px rgba(0,0,0,.35)}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,sans-serif;background:
    radial-gradient(1000px 600px at 80% -10%, rgba(122,60,255,.15), transparent 60%),
    radial-gradient(900px 500px at -10% 20%, rgba(122,60,255,.12), transparent 60%), var(--bg);
    color:var(--ink);line-height:1.6}
  a{color:var(--ink);text-decoration:none}
  .wrap{max-width:1100px;margin:auto;padding:20px}
  header{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:8px 0 20px}
  .brand{display:flex;align-items:center;gap:12px}
  .brand img{width:100px;height:100px;object-fit:contain;border-radius:10px;background:#0f0f16;border:1px solid var(--border)}
  .title{font-weight:800;letter-spacing:.3px}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--border);color:var(--muted);font-size:.85rem}
  .btn{appearance:none;border:1px solid var(--border);background:var(--accent-2);color:#fff;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer;transition:.2s transform ease}
  .btn:hover{transform:translateY(-1px)}
  .btn.primary{background:linear-gradient(0deg, rgba(122,60,255,.2), rgba(122,60,255,.2)), var(--accent);border-color:#5c29ef}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)), var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
  .p24{padding:24px}
  .hero{display:grid;grid-template-columns:1.1fr .9fr;gap:24px;align-items:stretch}
  .hero h1{margin:0 0 10px;font-size:clamp(26px,3.5vw,44px);line-height:1.1}
  .sub{color:var(--muted);margin:4px 0 18px}
  .grid{display:grid;gap:12px}
  .two{grid-template-columns:1fr 1fr}
  label{font-weight:600;font-size:.92rem}
  input,select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0f0f16;color:var(--ink);outline:none}
  input::placeholder,textarea::placeholder{color:#6f6f84}
  .help{font-size:.85rem;color:var(--muted)}
  .price{margin-top:10px;font-weight:800;font-size:1.1rem;background:#101018;border:1px dashed #2a2a3a;padding:10px 12px;border-radius:12px}
  .radio-row{display:flex;gap:10px;flex-wrap:wrap}
  .radio{display:flex;align-items:center;gap:8px;border:1px solid var(--border);padding:8px 10px;border-radius:10px;background:#0f0f16}
  .hero-media{display:block;position:relative;border-radius:16px;border:1px solid var(--border);overflow:hidden;aspect-ratio:16/9;background:#0f0f16}
  .hero-media img{width:100%;height:100%;object-fit:cover;display:block}
  footer{opacity:.9;padding:28px 8px;text-align:center;color:var(--muted)}
  @media (max-width:780px){.hero{grid-template-columns:1fr}.hero-media{aspect-ratio:3/2}}
  .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#0f0f16;border:1px solid #2a2a3a;padding:12px 16px;border-radius:12px;display:none;z-index:99}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img src="/assets/logo.png" alt="Kleenkars logo" onerror="this.src='/logo.svg'">
        <div>
          <div class="title">Kleenkars</div>
          <div class="pill">Premium • Wash • Detailing</div>
        </div>
      </div>
      <a class="pill" href="/admin.html">Admin login</a>
    </header>

    <section class="hero">
      <div class="card p24">
        <h1>Premium car care.</h1>
        <p class="sub">More than a wash — it’s a Kleenkars experience.</p>

        <form id="booking" class="grid" autocomplete="on" novalidate>
          <div class="grid two">
            <div>
              <label for="name">Customer name</label>
              <input id="name" name="name" placeholder="Full name" required>
            </div>
            <div>
              <label for="phone">Phone number</label>
              <input id="phone" name="phone" type="tel" inputmode="numeric" maxlength="10" placeholder="10-digit mobile" required>
            </div>
          </div>

          <div class="grid two">
            <div>
              <label for="vehicle">Vehicle type</label>
              <select id="vehicle" name="vehicle" required>
                <option value="" disabled selected>Select</option>
                <option value="Bike">Bike</option>
                <option value="Hatch/Sedan">Hatchback / Sedan</option>
                <option value="SUV">SUV</option>
              </select>
            </div>
            <div>
              <label for="service">Service</label>
              <select id="service" name="service" required>
                <option value="" disabled selected>Select vehicle first</option>
              </select>
              <div class="help" id="serviceHelp">Choose a vehicle to see pricing.</div>
            </div>
          </div>

          <div class="grid two">
            <div>
              <label for="date">Preferred date</label>
              <input type="date" id="date" name="date" required>
            </div>
            <div>
              <label for="time">Preferred time (10:00–20:00)</label>
              <input type="time" id="time" name="time" required step="900">
            </div>
          </div>

          <div>
            <label>Visit type</label>
            <div class="radio-row">
              <label class="radio"><input type="radio" name="visit" value="In-Shop" checked> In-Shop</label>
              <label class="radio"><input type="radio" name="visit" value="Home Visit"> Home Visit (+₹50)</label>
            </div>
          </div>

          <div id="addressWrap" style="display:none;">
            <label for="address">Address (for Home Visit)</label>
            <textarea id="address" name="address" rows="2" placeholder="House/Flat, Street, Area, City"></textarea>
          </div>

          <div class="price" id="priceBox">Estimated price: —</div>

          <button class="btn primary" type="button" id="confirm">Confirm Booking</button>
          <div class="help">Confirm saves your booking and opens WhatsApp confirmation.</div>
        </form>
      </div>

      <picture class="hero-media" aria-label="Kleenkars foam wash in action">
        <source srcset="/assets/hero.webp" type="image/webp">
        <img src="/assets/hero.jpg" alt="Kleenkars foam wash in action" loading="lazy" decoding="async">
      </picture>
    </section>

    <footer>© <span id="yr"></span> Kleenkars • Aligarh • Open 10:00–20:00 Daily</footer>
  </div>

  <div class="toast" id="toast">✅ Booking confirmed!</div>

<script>
/* ---------- Elements ---------- */
const els = {
  vehicle: document.getElementById('vehicle'),
  service: document.getElementById('service'),
  serviceHelp: document.getElementById('serviceHelp'),
  name: document.getElementById('name'),
  phone: document.getElementById('phone'),
  date: document.getElementById('date'),
  time: document.getElementById('time'),
  visitRadios: document.querySelectorAll('input[name="visit"]'),
  addressWrap: document.getElementById('addressWrap'),
  address: document.getElementById('address'),
  priceBox: document.getElementById('priceBox'),
  confirm: document.getElementById('confirm'),
  toast: document.getElementById('toast')
};
document.getElementById('yr').textContent = new Date().getFullYear();
els.date.setAttribute('min', new Date().toISOString().split('T')[0]);
els.phone.addEventListener('input', ()=>{ els.phone.value = els.phone.value.replace(/\D/g,'').slice(0,10); });

/* ---------- Public services fetch with graceful fallback ---------- */
/* expected row shape: { name: string, bike: number|null, sedan: number|null, suv: number|null } */
let SERVICES = [];
const FALLBACK = [
  { name:"Basic",     bike:50,  sedan:150,  suv:200 },
  { name:"Premium",   bike:null,sedan:200,  suv:250 },
  { name:"Detailing", bike:null,sedan:1500, suv:2500 }
];

async function tryFetch(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error("HTTP "+r.status);
  const d = await r.json();
  // support both {ok:true, rows:[...]} and plain arrays
  if(Array.isArray(d)) return d;
  if(d && d.ok && Array.isArray(d.rows)) return d.rows;
  throw new Error("Unexpected response");
}

async function loadServices(){
  const candidates = [
    "/.netlify/functions/admin-services?public=1", // if you allow GET public in your function
    "/.netlify/functions/site-settings?fn=services", // if you expose via site-settings
    "/.netlify/functions/services" // optional dedicated public endpoint if you add later
  ];
  for(const url of candidates){
    try{
      const rows = await tryFetch(url);
      if(rows && rows.length){ SERVICES = rows; return; }
    }catch(e){ /* continue to next */ }
  }
  // fallback to built-in prices if no public API available
  SERVICES = FALLBACK;
}
await loadServices();

/* ---------- Helpers ---------- */
function getVisit(){ return [...els.visitRadios].find(r=>r.checked)?.value || "In-Shop"; }

function servicesForVehicle(v){
  if(!v) return [];
  const key = v==="Bike" ? "bike" : (v==="SUV" ? "suv" : "sedan");
  return SERVICES.filter(s => s && s.name && s[key]!=null).map(s => ({
    name:s.name, price:s[key]
  }));
}

function populateServices(){
  const v = els.vehicle.value;
  els.service.innerHTML = `<option value="" disabled selected>${v ? "Select" : "Select vehicle first"}</option>`;
  const list = servicesForVehicle(v);
  if(list.length===0){
    els.serviceHelp.textContent = v ? "No services available for this vehicle." : "Choose a vehicle to see pricing.";
    updatePriceUI();
    return;
  }
  list.forEach(item=>{
    const opt = document.createElement("option");
    opt.value = item.name;
    opt.textContent = `${item.name} — ₹${item.price}`;
    opt.dataset.price = item.price;
    els.service.appendChild(opt);
  });
  // build dynamic help line with all prices for the chosen vehicle
  els.serviceHelp.textContent = list.map(i=>`${i.name} ₹${i.price}`).join(" • ");
  updatePriceUI();
}

function computePrice(){
  const v = els.vehicle.value, s = els.service.value;
  if(!v || !s) return null;
  const list = servicesForVehicle(v);
  const item = list.find(x=>x.name===s);
  if(!item) return null;
  let p = Number(item.price);
  if(getVisit()==="Home Visit") p += 50;
  return p;
}
function updatePriceUI(){
  const v = els.vehicle.value, s = els.service.value;
  const p = computePrice();
  if(p!=null){
    els.priceBox.innerHTML = `Estimated price: <b>₹${p}</b> <span class="help">(${s} • ${v}${getVisit()==="Home Visit"?" +₹50":""})</span>`;
  } else {
    els.priceBox.textContent = "Estimated price: —";
  }
}

function visitChanged(){
  const v = getVisit();
  els.addressWrap.style.display = v==="Home Visit" ? "block" : "none";
  if(v==="Home Visit"){ els.address?.setAttribute('required','required'); } else { els.address?.removeAttribute('required'); els.address.value=""; }
}

/* ---------- Bind ---------- */
['change','input'].forEach(ev=>{
  els.vehicle.addEventListener(ev, populateServices);
  els.service.addEventListener(ev, updatePriceUI);
  els.visitRadios.forEach(r=>r.addEventListener(ev, ()=>{ visitChanged(); updatePriceUI(); }));
});
visitChanged();
populateServices(); // initial render in case a default vehicle is preselected

/* ---------- Booking submit ---------- */
els.confirm.addEventListener('click', async ()=>{
  const raw = els.phone.value.replace(/\D/g,'');
  if(raw.length!==10){ alert("Enter a valid 10-digit number."); return; }

  const payload = {
    name: els.name.value.trim(),
    phone: raw,
    vehicle: els.vehicle.value,
    service: els.service.value,
    date: els.date.value,
    time: els.time.value,
    visit: getVisit(),
    address: els.address?.value.trim(),
    price: computePrice()
  };

  if(!payload.vehicle){ alert("Select a vehicle."); return; }
  if(!payload.service){ alert("Select a service."); return; }
  if(payload.price==null){ alert("Selected service is not available for this vehicle."); return; }

  els.confirm.disabled = true; els.confirm.textContent = "Saving…";
  try{
    const r = await fetch("/.netlify/functions/saveBooking", {
      method:"POST", headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    const data = await r.json();
    if(!data.ok) throw new Error(data.error||"Save failed");

    els.toast.textContent="✅ Booking confirmed!";
    els.toast.style.display="block";
    setTimeout(()=>els.toast.style.display="none",2500);

    const text = `KLEENKARS BOOKING\n\nName: ${payload.name}\nPhone: +91 ${payload.phone}\nVehicle: ${payload.vehicle}\nService: ${payload.service}\nVisit: ${payload.visit}\nPreferred: ${payload.date} ${payload.time}\nPrice: ₹${payload.price}`;
    if(data.admin) window.open(`https://api.whatsapp.com/send?phone=${data.admin}&text=${encodeURIComponent(text)}`, "_blank");
    if(data.manager) window.open(`https://api.whatsapp.com/send?phone=${data.manager}&text=${encodeURIComponent("NEW BOOKING ALERT\n\n"+text)}`, "_blank");

  }catch(e){
    alert(e.message);
  }finally{
    els.confirm.disabled=false; els.confirm.textContent="Confirm Booking";
  }
});
</script>
</body>
</html>
