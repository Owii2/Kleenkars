<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kleenkars Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  body{margin:0;font-family:Inter,system-ui,sans-serif;background:#0b0b12;color:#e9e9ef}
  header{display:flex;justify-content:space-between;align-items:center;padding:16px;background:#13131b;border-bottom:1px solid #242433}
  .title{font-size:1.3rem;font-weight:800}
  .btn{background:#7a3cff;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
  .btn:hover{background:#692fe0}
  .container{padding:20px;max-width:1000px;margin:auto}
  table{width:100%;border-collapse:collapse;margin-top:20px}
  th,td{padding:10px;border:1px solid #242433;text-align:left}
  th{background:#1d1d29}
  .muted{color:#b8b8c6;font-size:.9rem}
  .login{max-width:400px;margin:80px auto;padding:24px;background:#13131b;border:1px solid #242433;border-radius:12px}
  .login h2{margin-top:0;font-size:1.2rem}
  .login input{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #242433;background:#0f0f16;color:#fff}
</style>
</head>
<body>
  <header>
    <div class="title">Kleenkars Admin</div>
    <button id="logout" class="btn" style="display:none;">Logout</button>
  </header>

  <div id="loginWrap" class="login">
    <h2>Admin Login</h2>
    <input id="user" type="text" placeholder="Username" required>
    <input id="pass" type="password" placeholder="Password" required>
    <button id="loginBtn" class="btn">Login</button>
    <p class="muted">Only for authorized staff.</p>
  </div>

  <div id="adminWrap" class="container" style="display:none;">
    <h2>Bookings</h2>
    <table>
      <thead>
        <tr><th>Name</th><th>Phone</th><th>Vehicle</th><th>Service</th><th>Date/Time</th><th>Visit</th><th>Price</th></tr>
      </thead>
      <tbody id="bookings"></tbody>
    </table>
  </div>

<script>
  const els = {
    loginWrap: document.getElementById('loginWrap'),
    adminWrap: document.getElementById('adminWrap'),
    loginBtn: document.getElementById('loginBtn'),
    logout: document.getElementById('logout'),
    user: document.getElementById('user'),
    pass: document.getElementById('pass'),
    bookings: document.getElementById('bookings')
  };

  // Save token
  function saveToken(t){ localStorage.setItem("kleenkars_token", t); }
  function getToken(){ return localStorage.getItem("kleenkars_token"); }
  function clearToken(){ localStorage.removeItem("kleenkars_token"); }

  async function login(){
    const r = await fetch("/.netlify/functions/admin-login",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({user:els.user.value,pass:els.pass.value})
    });
    const d = await r.json();
    if(r.ok && d.token){ saveToken(d.token); showAdmin(); }
    else alert(d.error||"Login failed");
  }

  async function loadBookings(){
    const token = getToken();
    const r = await fetch("/.netlify/functions/admin-bookings",{ headers:{ Authorization:`Bearer ${token}` }});
    const d = await r.json();
    els.bookings.innerHTML="";
    if(d.ok){
      d.rows.forEach(b=>{
        const tr=document.createElement("tr");
        tr.innerHTML = `<td>${b.name}</td><td>${b.phone}</td><td>${b.vehicle}</td><td>${b.service}</td><td>${b.date} ${b.time}</td><td>${b.visit}</td><td>â‚¹${b.price}</td>`;
        els.bookings.appendChild(tr);
      });
    } else {
      alert(d.error||"Failed to load bookings");
    }
  }

  function showAdmin(){
    els.loginWrap.style.display="none";
    els.adminWrap.style.display="block";
    els.logout.style.display="inline-block";
    loadBookings();
  }

  els.loginBtn.addEventListener('click', login);
  els.logout.addEventListener('click', ()=>{ clearToken(); location.reload(); });

  // Auto-login if token exists
  if(getToken()){ showAdmin(); }
</script>
</body>
</html>
